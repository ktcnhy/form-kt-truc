<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>MyKTCN</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Prompt&display=swap');

    * {
      font-family: 'Prompt', sans-serif;
    }
  </style>
</head>

<body>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
    <div class="container d-flex align-items-center justify-content-center mt-5">
    <form class="row g-3" id="myForm" onsubmit="submitForm(this)">
      <h4 class="text-primary text-center">FORM KIỂM TRA TRỤC</h4>

      <div class="col-md-4 offset-md-4">
        <label for="madonhang" class="form-label">Mã đơn hàng</label>
        <input type="text" class="form-control" id="madonhang" name="madonhang" required>
      </div>
      
      <div class="col-md-4 offset-md-4">
        <label for="formFile" class="form-label">Tệp đính kèm</label>
        <input id="file" multiple class="form-control" type="file" onchange="saveFile(this)" required/>
      </div>
      
      <div class="col-md-4 offset-md-4">
        <label for="daikhung" class="form-label">Quy cách ống trục</label>
        <select class="form-select" id="quyCachTruc" name="quyCachTruc">
          <option disabled selected>Chọn</option>
          <option value="113.5x1.8">113.8x1.8</option>
          <option value="113.5x2.5">113.8x2.5</option>
          <option value="113.5x3.96">113.8x3.96</option>
          <option value="168x3.96">168x3.96</option>
          <option value="219x6.35">219x6.35</option>
        </select>
      </div>

          <div class="col-md-4 offset-md-4">
        <label for="loaiPully" class="form-label">Loại Pully</label>
        <select class="form-select" id="loaiPully" name="loaiPully">
          <option disabled selected>Chọn</option>
          <option value="P230S">230S</option>
          <option value="P230A">230A</option>
          <option value="P270S-114">270S-114</option>
          <option value="P270S-168">270S-168</option>
          <option value="P230">P230</option>
          <option value="P230DT">P230DT</option>
          <option value="P230STD">P230STD</option>
          <option value="P230FX">P230FX</option>
        </select>
      </div>
      
      <div class="col-md-4 offset-md-4">
        <label for="slPully" class="form-label">Số lượng Pully</label>
        <input type="number" class="form-control" id="slPully" name="slPully" required>
      </div>

       <div class="col-md-4 offset-md-4">
        <label for="phiaBoToi" class="form-label">Phía bộ tời</label>
        <select class="form-select" id="phiaBoToi" name="phiaBoToi">
          <option disabled selected>Chọn</option>
          <option value="L">L</option>
          <option value="R">R</option>
        </select>
      </div>

        <div class="col-md-4 offset-md-4">
        <label for="bitDauTruc" class="form-label">Bịt đầu trục</label>
        <select class="form-select" id="bitDauTruc" name="bitDauTruc">
          <option disabled selected>Chọn</option>
          <option value="Nhựa">Nhựa</option>
          <option value="Thép">Thép</option>
        </select>
      </div>
      
        <div class="col-md-4 offset-md-4">
        <label for="caMotor" class="form-label">Cá motor</label>
        <input type="number" class="form-control" id="caMotor" name="caMotor" required>
      </div>

        <div class="col-md-4 offset-md-4">
        <label for="Wcat" class="form-label">Chiều dài cắt</label>
        <input type="number" class="form-control" id="Wcat" name="Wcat" required>
      </div>

     <div class="col-md-4 offset-md-4">
        <label for="CLcat" class="form-label">Chất lượng cắt</label>
        <select class="form-select" id="CLcat" name="CLcat">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>

       <div class="col-md-4 offset-md-4">
        <label for="moiHan" class="form-label">Mối hàn</label>
        <select class="form-select" id="moiHan" name="moiHan">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="daoTruc" class="form-label">Độ đảo của trục</label>
        <select class="form-select" id="daoTruc" name="daoTruc">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>

          <div class="col-md-4 offset-md-4">
        <label for="congTruc" class="form-label">Độ cong của trục</label>
        <select class="form-select" id="congTruc" name="congTruc">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="thangPully" class="form-label">Độ thẳng của Pully</label>
        <select class="form-select" id="thangPully" name="thangPully">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>

      <div class="col-md-4 offset-md-4">
        <label for="vuongPully" class="form-label">Độ vuông góc của Pully</label>
        <select class="form-select" id="vuongPully" name="vuongPully">
          <option value="OK">OK</option>
          <option value="NG">NG</option>
        </select>
      </div>
      

      <div class="col-md-4 offset-md-4">
        <label for="ghichu" class="form-label">Ghi chú</label>
        <input type="text" class="form-control" id="ghichu" name="ghichu" >
      </div>

      <div class="col-md-4 offset-md-4">
        <button type="submit" class="btn btn-primary w-100">Gửi</button>
      </div>
    </form>
  </div>

  <script>

            //telegram
    const tg = window.Telegram.WebApp.initData;
    var tgdata = decodeURIComponent(tg.split('&')[1].substring(5));
    var telegram = JSON.parse(tgdata);
    
 function saveFile(f) {
      for(i=0; i<f.files.length; i++){
      const file = f.files[i];
      const fr = new FileReader();
      const madonhang = document.getElementById("madonhang").value;
    fr.readAsArrayBuffer(file);
    fr.onload = (e) => {
      const url = "https://script.google.com/macros/s/AKfycbyR3GNAATDbPhNbU4NGaPJ4nOjnlaS0ZYoNEHDI8oTAp34XRNuUV_NAx1CT8dxzxpST/exec"; // Please set the URL of Web Apps.

      const qs = new URLSearchParams({
        madonhang: madonhang,
        filename: file.name,
        mimeType: file.type,
      });
      fetch(`${url}?${qs}`, {
        method: "POST",
        body: JSON.stringify([...new Int8Array(e.target.result)]),
      })
        .then((res) => res.json())
        .then(console.log)
        .catch(console.log);
        };
      }
    }

    function submitForm(formObject){
    fetch(`https://script.google.com/macros/s/AKfycbyxk9qrTthKZTXJAG_EJv7uyqvtSVGSEqYFlN-XSGlDnZW7IW3vkLYv_aRwJSLqDztt4w/exec`, {
                  method : 'POST',
                  header : {'Content-Type': 'application/json'},
                  body : `{"madonhang" : "${formObject.madonhang.value}",
                          "quyCachTruc" : "${formObject.quyCachTruc.value}",
                          "loaiPully" : "${formObject.loaiPully.value}",
                          "slPully" : "${formObject.slPully.value}",
                          "phiaBoToi" : "${formObject.phiaBoToi.value}",
                          "bitDauTruc" : "${formObject.bitDauTruc.value}",
                          "caMotor" : "${formObject.caMotor.value}",
                          "Wcat" : "${formObject.Wcat.value}",
                          "CLcat" : "${formObject.CLcat.value}",
                          "moiHan" : "${formObject.moiHan.value}",
                          "daoTruc" : "${formObject.daoTruc.value}",
                          "congTruc" : "${formObject.congTruc.value}",
                          "thangPully" : "${formObject.thangPully.value}",
                          "vuongPully" : "${formObject.vuongPully.value}",
                          "ghichu" : "${formObject.ghichu.value}",
                          "chat_id" : "${telegram.id}"
                          }`
                  });
    document.getElementById("myForm").reset();
    window.alert("Dữ liệu đang gửi lên hệ thống")
    window.Telegram.WebApp.close()
    }

  </script>

</body>

</html>
